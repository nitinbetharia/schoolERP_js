<%- include('../../../partials/header', { title: title }) %>

<div class="container-fluid mt-4">
   <!-- Page Header -->
   <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
         <h1 class="h3 mb-0">
            <i class="fas fa-eye text-info me-2"></i>
            Section Details
         </h1>
         <nav aria-label="breadcrumb" class="mt-2">
            <ol class="breadcrumb">
               <% breadcrumb.forEach((item, index) => { %>
                  <% if (index === breadcrumb.length - 1) { %>
                     <li class="breadcrumb-item active" aria-current="page"><%= item.title %></li>
                  <% } else { %>
                     <li class="breadcrumb-item"><a href="<%= item.url %>"><%= item.title %></a></li>
                  <% } %>
               <% }) %>
            </ol>
         </nav>
      </div>
      <div>
         <a href="/admin/sections" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i>
            Back to Sections
         </a>
         <a href="/admin/sections/<%= sectionData.id %>/edit" class="btn btn-warning">
            <i class="fas fa-edit me-1"></i>
            Edit Section
         </a>
      </div>
   </div>

   <!-- Flash Messages -->
   <%- include('../../../partials/flash-messages') %>

   <!-- Section Details -->
   <div class="row">
      <!-- Main Information Card -->
      <div class="col-lg-8">
         <div class="card">
            <div class="card-header">
               <h5 class="card-title mb-0">
                  <i class="fas fa-info-circle me-2"></i>
                  Section Information
               </h5>
            </div>
            <div class="card-body">
               <!-- Basic Details -->
               <div class="row mb-4">
                  <div class="col-md-6">
                     <div class="mb-3">
                        <label class="form-label text-muted">Section Name</label>
                        <div class="h5 text-primary"><%= sectionData.name %></div>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <div class="mb-3">
                        <label class="form-label text-muted">Class</label>
                        <div class="h6">
                           <span class="badge bg-info fs-6">
                              <%= sectionData.class.name %> (<%= sectionData.class.code %>)
                           </span>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <div class="mb-3">
                        <label class="form-label text-muted">Capacity</label>
                        <div class="h6">
                           <% if (sectionData.capacity) { %>
                              <%= sectionData.capacity %> students
                           <% } else { %>
                              <span class="text-muted">Not set</span>
                           <% } %>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <div class="mb-3">
                        <label class="form-label text-muted">Current Strength</label>
                        <div class="h6">
                           <span class="text-success"><%= sectionData.current_strength || 0 %></span> students enrolled
                           <% if (sectionData.capacity) { %>
                              <small class="text-muted">
                                 (<%= Math.round((sectionData.current_strength || 0) / sectionData.capacity * 100) %>% filled)
                              </small>
                           <% } %>
                        </div>
                     </div>
                  </div>
               </div>

               <!-- Teacher and Room Information -->
               <div class="row mb-4">
                  <div class="col-md-6">
                     <div class="mb-3">
                        <label class="form-label text-muted">Section Teacher</label>
                        <div class="h6">
                           <% if (sectionData.section_teacher_name) { %>
                              <i class="fas fa-user-tie text-success me-2"></i>
                              <%= sectionData.section_teacher_name %>
                           <% } else { %>
                              <span class="text-muted">
                                 <i class="fas fa-user-slash me-2"></i>
                                 No teacher assigned
                              </span>
                           <% } %>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <div class="mb-3">
                        <label class="form-label text-muted">Room Number</label>
                        <div class="h6">
                           <% if (sectionData.room_number) { %>
                              <i class="fas fa-door-open text-info me-2"></i>
                              <%= sectionData.room_number %>
                           <% } else { %>
                              <span class="text-muted">
                                 <i class="fas fa-door-closed me-2"></i>
                                 No room assigned
                              </span>
                           <% } %>
                        </div>
                     </div>
                  </div>
               </div>

               <!-- Description -->
               <% if (sectionData.description) { %>
               <div class="row mb-4">
                  <div class="col-12">
                     <div class="mb-3">
                        <label class="form-label text-muted">Description</label>
                        <div class="border rounded p-3 bg-light">
                           <%= sectionData.description %>
                        </div>
                     </div>
                  </div>
               </div>
               <% } %>

               <!-- Status and Timestamps -->
               <div class="row">
                  <div class="col-md-4">
                     <div class="mb-3">
                        <label class="form-label text-muted">Status</label>
                        <div>
                           <% if (sectionData.is_active) { %>
                              <span class="badge bg-success fs-6">
                                 <i class="fas fa-check-circle me-1"></i>
                                 Active
                              </span>
                           <% } else { %>
                              <span class="badge bg-secondary fs-6">
                                 <i class="fas fa-times-circle me-1"></i>
                                 Inactive
                              </span>
                           <% } %>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-4">
                     <div class="mb-3">
                        <label class="form-label text-muted">Created</label>
                        <div class="small">
                           <%= new Date(sectionData.created_at).toLocaleDateString() %>
                           <br>
                           <span class="text-muted">
                              <%= new Date(sectionData.created_at).toLocaleTimeString() %>
                           </span>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-4">
                     <div class="mb-3">
                        <label class="form-label text-muted">Last Updated</label>
                        <div class="small">
                           <%= new Date(sectionData.updated_at).toLocaleDateString() %>
                           <br>
                           <span class="text-muted">
                              <%= new Date(sectionData.updated_at).toLocaleTimeString() %>
                           </span>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- Quick Actions Sidebar -->
      <div class="col-lg-4">
         <!-- Quick Actions Card -->
         <div class="card">
            <div class="card-header">
               <h6 class="card-title mb-0">
                  <i class="fas fa-bolt me-2"></i>
                  Quick Actions
               </h6>
            </div>
            <div class="card-body">
               <div class="d-grid gap-2">
                  <a href="/admin/sections/<%= sectionData.id %>/edit" class="btn btn-warning">
                     <i class="fas fa-edit me-2"></i>
                     Edit Section
                  </a>
                  <a href="/admin/sections/<%= sectionData.id %>/students" class="btn btn-info">
                     <i class="fas fa-user-graduate me-2"></i>
                     Manage Students
                  </a>
                  <a href="/admin/sections/<%= sectionData.id %>/subjects" class="btn btn-success">
                     <i class="fas fa-book me-2"></i>
                     Assign Subjects
                  </a>
                  <a href="/admin/sections/<%= sectionData.id %>/timetable" class="btn btn-primary">
                     <i class="fas fa-calendar-alt me-2"></i>
                     View Timetable
                  </a>
                  <a href="/admin/sections/<%= sectionData.id %>/attendance" class="btn btn-outline-primary">
                     <i class="fas fa-clipboard-check me-2"></i>
                     Attendance Report
                  </a>
                  <hr>
                  <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                     <i class="fas fa-trash me-2"></i>
                     Delete Section
                  </button>
               </div>
            </div>
         </div>

         <!-- Statistics Card -->
         <div class="card mt-3">
            <div class="card-header">
               <h6 class="card-title mb-0">
                  <i class="fas fa-chart-pie me-2"></i>
                  Statistics
               </h6>
            </div>
            <div class="card-body">
               <div class="row g-3">
                  <!-- Capacity Utilization -->
                  <div class="col-12">
                     <div class="d-flex justify-content-between">
                        <span class="text-muted">Capacity Utilization</span>
                        <% if (sectionData.capacity) { %>
                           <% const utilizationPercent = Math.round((sectionData.current_strength || 0) / sectionData.capacity * 100) %>
                           <span class="fw-bold"><%= utilizationPercent %>%</span>
                        <% } else { %>
                           <span class="text-muted">N/A</span>
                        <% } %>
                     </div>
                     <% if (sectionData.capacity) { %>
                        <div class="progress mt-1" style="height: 6px;">
                           <% const utilizationPercent = Math.round((sectionData.current_strength || 0) / sectionData.capacity * 100) %>
                           <div class="progress-bar 
                                       <%= utilizationPercent > 90 ? 'bg-danger' : utilizationPercent > 75 ? 'bg-warning' : 'bg-success' %>" 
                                style="width: <%= utilizationPercent %>%">
                           </div>
                        </div>
                     <% } %>
                  </div>

                  <!-- Available Seats -->
                  <div class="col-6">
                     <div class="text-center border rounded p-2">
                        <div class="h6 mb-0 text-success">
                           <% if (sectionData.capacity) { %>
                              <%= sectionData.capacity - (sectionData.current_strength || 0) %>
                           <% } else { %>
                              ∞
                           <% } %>
                        </div>
                        <small class="text-muted">Available</small>
                     </div>
                  </div>

                  <!-- Current Students -->
                  <div class="col-6">
                     <div class="text-center border rounded p-2">
                        <div class="h6 mb-0 text-primary">
                           <%= sectionData.current_strength || 0 %>
                        </div>
                        <small class="text-muted">Enrolled</small>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <!-- Section Info Card -->
         <div class="card mt-3">
            <div class="card-header">
               <h6 class="card-title mb-0">
                  <i class="fas fa-info me-2"></i>
                  Section ID
               </h6>
            </div>
            <div class="card-body">
               <div class="text-center">
                  <div class="h4 text-muted mb-0">#<%= sectionData.id %></div>
                  <small class="text-muted">Section Identifier</small>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title">
               <i class="fas fa-exclamation-triangle text-warning me-2"></i>
               Confirm Deletion
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
         </div>
         <div class="modal-body">
            <p>Are you sure you want to delete section <strong><%= sectionData.name %></strong> from <strong><%= sectionData.class.name %></strong>?</p>
            <div class="alert alert-warning">
               <i class="fas fa-exclamation-circle me-2"></i>
               <strong>Warning:</strong> This action cannot be undone. The section will be deactivated and hidden from active lists.
            </div>
            <% if (sectionData.current_strength > 0) { %>
            <div class="alert alert-danger">
               <i class="fas fa-users me-2"></i>
               <strong>Students Enrolled:</strong> This section currently has <strong><%= sectionData.current_strength %></strong> active students. 
               Please transfer them to other sections before deletion.
            </div>
            <% } %>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
               <i class="fas fa-times me-1"></i>
               Cancel
            </button>
            <% if (sectionData.current_strength === 0) { %>
            <button type="button" class="btn btn-danger" onclick="deleteSection()">
               <i class="fas fa-trash me-1"></i>
               Delete Section
            </button>
            <% } else { %>
            <button type="button" class="btn btn-danger" disabled>
               <i class="fas fa-ban me-1"></i>
               Cannot Delete (Students Enrolled)
            </button>
            <% } %>
         </div>
      </div>
   </div>
</div>

<!-- JavaScript -->
<script>
function confirmDelete() {
   const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
   modal.show();
}

function deleteSection() {
   const sectionId = <%= sectionData.id %>;
   
   fetch(`/admin/sections/${sectionId}`, {
      method: 'DELETE',
      headers: {
         'Content-Type': 'application/json',
         'X-Requested-With': 'XMLHttpRequest'
      }
   })
   .then(response => response.json())
   .then(data => {
      if (data.success) {
         // Show success message and redirect
         alert('Section deleted successfully!');
         window.location.href = '/admin/sections';
      } else {
         // Show error message
         alert('Error: ' + (data.error || 'Failed to delete section'));
      }
   })
   .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while deleting the section');
   });
}
</script>

<%- include('../../../partials/footer') %>
