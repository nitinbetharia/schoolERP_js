<%- include('../../../partials/header', { title: title }) %>

<div class="container-fluid mt-4">
   <!-- Page Header -->
   <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
         <h1 class="h3 mb-0">
            <i class="fas fa-users text-info me-2"></i>
            Sections Management
         </h1>
         <nav aria-label="breadcrumb" class="mt-2">
            <ol class="breadcrumb">
               <% breadcrumb.forEach((item, index) => { %>
                  <% if (index === breadcrumb.length - 1) { %>
                     <li class="breadcrumb-item active" aria-current="page"><%= item.title %></li>
                  <% } else { %>
                     <li class="breadcrumb-item"><a href="<%= item.url %>"><%= item.title %></a></li>
                  <% } %>
               <% }) %>
            </ol>
         </nav>
      </div>
      <div>
         <a href="/admin/sections/create" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>
            Add New Section
         </a>
      </div>
   </div>

   <!-- Flash Messages -->
   <%- include('../../../partials/flash-messages') %>

   <!-- Statistics Cards -->
   <div class="row mb-4">
      <div class="col-xl-3 col-md-6 mb-3">
         <div class="card bg-primary text-white">
            <div class="card-body">
               <div class="d-flex justify-content-between">
                  <div>
                     <h6 class="text-uppercase text-white-50">Total Sections</h6>
                     <h2 class="mb-0"><%= sections.length %></h2>
                  </div>
                  <div class="align-self-center">
                     <i class="fas fa-users fa-2x text-white-50"></i>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
         <div class="card bg-success text-white">
            <div class="card-body">
               <div class="d-flex justify-content-between">
                  <div>
                     <h6 class="text-uppercase text-white-50">Active Sections</h6>
                     <h2 class="mb-0"><%= totalActiveSections %></h2>
                  </div>
                  <div class="align-self-center">
                     <i class="fas fa-check-circle fa-2x text-white-50"></i>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
         <div class="card bg-info text-white">
            <div class="card-body">
               <div class="d-flex justify-content-between">
                  <div>
                     <h6 class="text-uppercase text-white-50">Total Students</h6>
                     <h2 class="mb-0"><%= totalStudents %></h2>
                  </div>
                  <div class="align-self-center">
                     <i class="fas fa-user-graduate fa-2x text-white-50"></i>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
         <div class="card bg-warning text-white">
            <div class="card-body">
               <div class="d-flex justify-content-between">
                  <div>
                     <h6 class="text-uppercase text-white-50">Avg Capacity</h6>
                     <h2 class="mb-0"><%= averageCapacity %></h2>
                  </div>
                  <div class="align-self-center">
                     <i class="fas fa-chart-bar fa-2x text-white-50"></i>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>

   <!-- Search and Filter Section -->
   <div class="card mb-4">
      <div class="card-header">
         <h5 class="card-title mb-0">
            <i class="fas fa-search me-2"></i>
            Search & Filter Sections
         </h5>
      </div>
      <div class="card-body">
         <form method="GET" action="/admin/sections" class="row g-3">
            <!-- Search -->
            <div class="col-md-4">
               <label for="search" class="form-label">Search</label>
               <input 
                  type="text" 
                  class="form-control" 
                  id="search" 
                  name="search" 
                  value="<%= filters.search %>" 
                  placeholder="Section name, class, room...">
            </div>

            <!-- Class Filter -->
            <div class="col-md-3">
               <label for="class_id" class="form-label">Class</label>
               <select class="form-select" id="class_id" name="class_id">
                  <option value="">All Classes</option>
                  <% classes.forEach(function(cls) { %>
                     <option value="<%= cls.id %>" <%= filters.class_id == cls.id ? 'selected' : '' %>>
                        <%= cls.name %> (<%= cls.code %>)
                     </option>
                  <% }); %>
               </select>
            </div>

            <!-- Status Filter -->
            <div class="col-md-3">
               <label for="is_active" class="form-label">Status</label>
               <select class="form-select" id="is_active" name="is_active">
                  <option value="">All Status</option>
                  <option value="true" <%= filters.is_active === 'true' ? 'selected' : '' %>>Active</option>
                  <option value="false" <%= filters.is_active === 'false' ? 'selected' : '' %>>Inactive</option>
               </select>
            </div>

            <!-- Actions -->
            <div class="col-md-2">
               <label class="form-label">&nbsp;</label>
               <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-outline-primary">
                     <i class="fas fa-search me-1"></i>
                     Filter
                  </button>
               </div>
            </div>
         </form>
      </div>
   </div>

   <!-- Sections Table -->
   <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
         <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>
            Sections List
         </h5>
         <div class="text-muted small">
            Showing <%= sections.length %> sections
         </div>
      </div>
      <div class="card-body p-0">
         <div class="table-responsive">
            <table class="table table-hover mb-0">
               <thead class="table-light">
                  <tr>
                     <th scope="col">#</th>
                     <th scope="col">Section</th>
                     <th scope="col">Class</th>
                     <th scope="col">Teacher</th>
                     <th scope="col">Room</th>
                     <th scope="col">Capacity</th>
                     <th scope="col">Students</th>
                     <th scope="col">Status</th>
                     <th scope="col">Actions</th>
                  </tr>
               </thead>
               <tbody>
                  <% if (sections.length === 0) { %>
                     <tr>
                        <td colspan="9" class="text-center py-4">
                           <div class="text-muted">
                              <i class="fas fa-info-circle fa-2x mb-2"></i>
                              <p class="mb-0">No sections found.</p>
                              <% if (filters.search || filters.class_id || filters.is_active) { %>
                                 <small>Try adjusting your filter criteria.</small>
                              <% } else { %>
                                 <a href="/admin/sections/create" class="btn btn-sm btn-primary mt-2">
                                    <i class="fas fa-plus me-1"></i>
                                    Create First Section
                                 </a>
                              <% } %>
                           </div>
                        </td>
                     </tr>
                  <% } else { %>
                     <% sections.forEach(function(section, index) { %>
                        <tr>
                           <td><%= index + 1 %></td>
                           <td>
                              <div class="d-flex align-items-center">
                                 <div class="avatar-sm bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                    <%= section.name %>
                                 </div>
                                 <div>
                                    <h6 class="mb-0">Section <%= section.name %></h6>
                                    <small class="text-muted">ID: #<%= section.id %></small>
                                 </div>
                              </div>
                           </td>
                           <td>
                              <span class="badge bg-primary">
                                 <%= section.class_name %> (<%= section.class_code %>)
                              </span>
                           </td>
                           <td>
                              <% if (section.section_teacher_name) { %>
                                 <div>
                                    <strong><%= section.section_teacher_name %></strong>
                                    <small class="d-block text-muted">Section Teacher</small>
                                 </div>
                              <% } else { %>
                                 <span class="text-muted">
                                    <i class="fas fa-user-slash me-1"></i>
                                    Not Assigned
                                 </span>
                              <% } %>
                           </td>
                           <td>
                              <% if (section.room_number) { %>
                                 <span class="badge bg-secondary">
                                    <i class="fas fa-door-open me-1"></i>
                                    <%= section.room_number %>
                                 </span>
                              <% } else { %>
                                 <span class="text-muted">Not assigned</span>
                              <% } %>
                           </td>
                           <td>
                              <span class="fw-bold text-primary">
                                 <%= section.capacity || 'N/A' %>
                              </span>
                           </td>
                           <td>
                              <div class="d-flex align-items-center">
                                 <span class="fw-bold text-success me-2">
                                    <%= section.current_strength || 0 %>
                                 </span>
                                 <% if (section.capacity && section.current_strength) { %>
                                    <% const percentage = Math.round((section.current_strength / section.capacity) * 100) %>
                                    <div class="progress" style="width: 60px; height: 8px;">
                                       <div class="progress-bar 
                                          <%= percentage > 90 ? 'bg-danger' : (percentage > 75 ? 'bg-warning' : 'bg-success') %>" 
                                          role="progressbar" 
                                          style="width: <%= percentage %>%;" 
                                          aria-valuenow="<%= percentage %>" 
                                          aria-valuemin="0" 
                                          aria-valuemax="100">
                                       </div>
                                    </div>
                                 <% } %>
                              </div>
                           </td>
                           <td>
                              <% if (section.is_active) { %>
                                 <span class="badge bg-success">Active</span>
                              <% } else { %>
                                 <span class="badge bg-secondary">Inactive</span>
                              <% } %>
                           </td>
                           <td>
                              <div class="btn-group btn-group-sm" role="group">
                                 <a href="/admin/sections/<%= section.id %>" 
                                    class="btn btn-outline-info" 
                                    title="View Section Details">
                                    <i class="fas fa-eye"></i>
                                 </a>
                                 <a href="/admin/sections/<%= section.id %>/edit" 
                                    class="btn btn-outline-primary" 
                                    title="Edit Section">
                                    <i class="fas fa-edit"></i>
                                 </a>
                                 <button type="button" 
                                         class="btn btn-outline-danger" 
                                         onclick="confirmDelete('<%= section.id %>', 'Section <%= section.name %> (<%= section.class_name %>)')"
                                         title="Delete Section">
                                    <i class="fas fa-trash"></i>
                                 </button>
                              </div>
                           </td>
                        </tr>
                     <% }); %>
                  <% } %>
               </tbody>
            </table>
         </div>
      </div>
   </div>

   <!-- Pagination -->
   <% if (pagination.totalPages > 1) { %>
      <nav aria-label="Sections pagination" class="mt-4">
         <ul class="pagination justify-content-center">
            <% if (pagination.currentPage > 1) { %>
               <li class="page-item">
                  <a class="page-link" href="?page=<%= pagination.currentPage - 1 %><%= filters.search ? '&search=' + filters.search : '' %><%= filters.class_id ? '&class_id=' + filters.class_id : '' %><%= filters.is_active ? '&is_active=' + filters.is_active : '' %>">
                     Previous
                  </a>
               </li>
            <% } %>

            <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
               <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %><%= filters.search ? '&search=' + filters.search : '' %><%= filters.class_id ? '&class_id=' + filters.class_id : '' %><%= filters.is_active ? '&is_active=' + filters.is_active : '' %>">
                     <%= i %>
                  </a>
               </li>
            <% } %>

            <% if (pagination.currentPage < pagination.totalPages) { %>
               <li class="page-item">
                  <a class="page-link" href="?page=<%= pagination.currentPage + 1 %><%= filters.search ? '&search=' + filters.search : '' %><%= filters.class_id ? '&class_id=' + filters.class_id : '' %><%= filters.is_active ? '&is_active=' + filters.is_active : '' %>">
                     Next
                  </a>
               </li>
            <% } %>
         </ul>
      </nav>
   <% } %>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body">
            <div class="text-center">
               <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
               <h5>Are you sure you want to delete this section?</h5>
               <p id="deleteMessage" class="text-muted mb-3"></p>
               <div class="alert alert-warning">
                  <small>
                     <i class="fas fa-info-circle me-1"></i>
                     Warning: This action cannot be undone. Students in this section may be affected.
                  </small>
               </div>
            </div>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
               <i class="fas fa-trash me-1"></i>
               Delete Section
            </button>
         </div>
      </div>
   </div>
</div>

<!-- Scripts -->
<script>
   let sectionToDelete = null;

   function confirmDelete(sectionId, sectionName) {
      sectionToDelete = sectionId;
      document.getElementById('deleteMessage').textContent = `Section: ${sectionName}`;
      
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
      deleteModal.show();
   }

   document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
      if (!sectionToDelete) return;

      try {
         this.disabled = true;
         this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Deleting...';

         const response = await fetch(`/admin/sections/${sectionToDelete}`, {
            method: 'DELETE',
            headers: {
               'Content-Type': 'application/json',
            }
         });

         const result = await response.json();

         if (result.success) {
            location.reload();
         } else {
            alert('Error: ' + result.message);
         }
      } catch (error) {
         console.error('Delete error:', error);
         alert('Failed to delete section. Please try again.');
      } finally {
         this.disabled = false;
         this.innerHTML = '<i class="fas fa-trash me-1"></i> Delete Section';
      }
   });
</script>

<%- include('../../../partials/footer') %>
