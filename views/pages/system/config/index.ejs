<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>System Configuration | School ERP System</title>
      <meta name="description" content="System-wide configuration and settings" />

      <!-- Bootstrap CSS -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
      <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
   </head>
   <body class="bg-light">
      <%- include('../../partials/header/authenticated') %>

      <div class="container-fluid">
         <div class="row">
            <!-- Sidebar -->
            <%- include('../../partials/nav/system-admin') %>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
               <div
                  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2"><i class="bi bi-gear"></i> System Configuration</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                     <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                           <i class="bi bi-arrow-clockwise"></i> Reload Config
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning">
                           <i class="bi bi-shield-check"></i> Backup Settings
                        </button>
                     </div>
                  </div>
               </div>

               <!-- Flash Messages -->
               <%- include('../../partials/flash-messages') %>

               <!-- Configuration Sections (rendered by server for section + configData) -->
               <div class="row g-4">
                  <div class="col-12">
                     <div class="alert alert-secondary">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Editing section:</strong>
                        <span class="text-uppercase"><%= section || 'general' %></span>
                     </div>
                  </div>
                  <div class="col-lg-8">
                     <div class="card">
                        <div class="card-header">
                           <h5 class="card-title mb-0">Update <%= (section || 'general') %> configuration</h5>
                        </div>
                        <div class="card-body">
                           <form method="post" action="/system/config/<%= section %>">
                              <% if (section === 'general') { %>
                                 <div class="row g-3">
                                    <div class="col-md-6">
                                       <label class="form-label">Timezone</label>
                                       <input name="timezone" class="form-control" value="<%= configData.timezone %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Locale</label>
                                       <input name="locale" class="form-control" value="<%= configData.locale %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Currency</label>
                                       <input name="currency" class="form-control" value="<%= configData.currency %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Academic Year Start Month</label>
                                       <input name="academicYearStartMonth" type="number" class="form-control" value="<%= configData.academicYearStartMonth %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Branding Name</label>
                                       <input name="branding_name" class="form-control" value="<%= configData.branding?.name %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Branding Logo URL</label>
                                       <input name="branding_logo" class="form-control" value="<%= configData.branding?.logo %>" />
                                    </div>
                                 </div>
                              <% } %>

                              <% if (section === 'security') { %>
                                 <div class="row g-3">
                                    <div class="col-md-6">
                                       <label class="form-label">Session Max Age (ms)</label>
                                       <input name="sessionMaxAge" type="number" class="form-control" value="<%= configData.sessionMaxAge %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Max Login Attempts</label>
                                       <input name="maxLoginAttempts" type="number" class="form-control" value="<%= configData.maxLoginAttempts %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Lockout Time (ms)</label>
                                       <input name="lockoutTimeMs" type="number" class="form-control" value="<%= configData.lockoutTimeMs %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Bcrypt Rounds</label>
                                       <input name="bcryptRounds" type="number" class="form-control" value="<%= configData.bcryptRounds %>" />
                                    </div>
                                    <div class="col-md-12 form-check mt-2">
                                       <input class="form-check-input" type="checkbox" id="twoFactorEnabled" name="twoFactorEnabled" <%= configData.twoFactor?.enabled ? 'checked' : '' %> />
                                       <label class="form-check-label" for="twoFactorEnabled">Enable Two-Factor Authentication</label>
                                    </div>
                                 </div>
                              <% } %>

                              <% if (section === 'email') { %>
                                 <div class="row g-3">
                                    <div class="col-md-6">
                                       <label class="form-label">SMTP Host</label>
                                       <input name="host" class="form-control" value="<%= configData.host %>" />
                                    </div>
                                    <div class="col-md-3">
                                       <label class="form-label">Port</label>
                                       <input name="port" type="number" class="form-control" value="<%= configData.port %>" />
                                    </div>
                                    <div class="col-md-3 form-check mt-4 pt-2">
                                       <input class="form-check-input" type="checkbox" id="secure" name="secure" <%= configData.secure ? 'checked' : '' %> />
                                       <label class="form-check-label" for="secure">Secure (TLS)</label>
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">User</label>
                                       <input name="user" class="form-control" value="<%= configData.user %>" />
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">From Address</label>
                                       <input name="from" class="form-control" value="<%= configData.from %>" />
                                    </div>
                                 </div>
                              <% } %>

                              <% if (section === 'integrations') { %>
                                 <div class="row g-3">
                                    <div class="col-md-6">
                                       <label class="form-label">Payment Gateway</label>
                                       <select class="form-select" name="paymentProvider">
                                          <option value="none" <%= configData.paymentGateway?.provider === 'none' ? 'selected' : '' %>>None</option>
                                          <option value="razorpay" <%= configData.paymentGateway?.provider === 'razorpay' ? 'selected' : '' %>>Razorpay</option>
                                          <option value="stripe" <%= configData.paymentGateway?.provider === 'stripe' ? 'selected' : '' %>>Stripe</option>
                                       </select>
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">SMS Provider</label>
                                       <select class="form-select" name="smsProvider">
                                          <option value="none" <%= configData.sms?.provider === 'none' ? 'selected' : '' %>>None</option>
                                          <option value="twilio" <%= configData.sms?.provider === 'twilio' ? 'selected' : '' %>>Twilio</option>
                                       </select>
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Storage Provider</label>
                                       <select class="form-select" name="storageProvider">
                                          <option value="local" <%= configData.storage?.provider === 'local' ? 'selected' : '' %>>Local</option>
                                          <option value="s3" <%= configData.storage?.provider === 's3' ? 'selected' : '' %>>S3</option>
                                       </select>
                                    </div>
                                    <div class="col-md-6">
                                       <label class="form-label">Analytics Provider</label>
                                       <select class="form-select" name="analyticsProvider">
                                          <option value="none" <%= configData.analytics?.provider === 'none' ? 'selected' : '' %>>None</option>
                                          <option value="appinsights" <%= configData.analytics?.provider === 'appinsights' ? 'selected' : '' %>>Azure Application Insights</option>
                                       </select>
                                    </div>
                                 </div>
                              <% } %>

                              <div class="mt-4 d-flex gap-2">
                                 <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-1"></i> Save Changes
                                 </button>
                                 <a href="/system/config/<%= section %>" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Reset
                                 </a>
                              </div>
                           </form>
                        </div>
                     </div>
                  </div>
                  <div class="col-lg-4">
                     <div class="card">
                        <div class="card-header bg-light">
                           <h5 class="card-title mb-0">Quick Links</h5>
                        </div>
                        <div class="list-group list-group-flush">
                           <a class="list-group-item list-group-item-action <%= section==='general' ? 'active' : '' %>" href="/system/config/general">
                              <i class="bi bi-sliders me-2"></i>General
                           </a>
                           <a class="list-group-item list-group-item-action <%= section==='security' ? 'active' : '' %>" href="/system/config/security">
                              <i class="bi bi-shield-lock me-2"></i>Security
                           </a>
                           <a class="list-group-item list-group-item-action <%= section==='email' ? 'active' : '' %>" href="/system/config/email">
                              <i class="bi bi-envelope-at me-2"></i>Email
                           </a>
                           <a class="list-group-item list-group-item-action <%= section==='integrations' ? 'active' : '' %>" href="/system/config/integrations">
                              <i class="bi bi-diagram-3 me-2"></i>Integrations
                           </a>
                        </div>
                     </div>
                  </div>
               </div>

               <!-- Current Configuration Status -->
               <div class="row mt-4">
                  <div class="col-12">
                     <div class="card">
                        <div class="card-header">
                           <h5 class="card-title mb-0">
                              <i class="bi bi-info-circle"></i> Current Configuration Status
                           </h5>
                        </div>
                        <div class="card-body">
                           <div class="row">
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <div class="h4 text-primary">4</div>
                                    <div class="text-muted small">Configuration Areas</div>
                                 </div>
                              </div>
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <div class="h4 text-warning">0</div>
                                    <div class="text-muted small">Configured</div>
                                 </div>
                              </div>
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <div class="h4 text-info">4</div>
                                    <div class="text-muted small">Pending Setup</div>
                                 </div>
                              </div>
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <div class="h4 text-success">100%</div>
                                    <div class="text-muted small">System Ready</div>
                                 </div>
                              </div>
                           </div>

                           <hr />

                           <div class="alert alert-info mb-0">
                              <i class="bi bi-lightbulb me-2"></i>
                              <strong>Pro Tip:</strong> The system is running with default configurations. Advanced
                              configuration features will be available in the next release to customize system behavior
                              according to your organization's needs.
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </main>
         </div>
      </div>

      <!-- Bootstrap JS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

      <script>
         // Optional: hook up reload/backup later
      </script>
   </body>
</html>
