<%- include('../../partials/header') %>

<div class="fee-payment-container">
  <div class="payment-card">
    <div class="card-header">
      <h2 class="payment-title">
        <i class="fas fa-credit-card"></i>
        Fee Payment
      </h2>
      <div class="student-info">
        <span class="student-name"><%= student.name %></span>
        <span class="student-id">ID: <%= student.id %></span>
      </div>
    </div>

    <div class="card-body">
      <!-- Fee Summary Section -->
      <div class="fee-summary">
        <h3 class="section-title">Payment Summary</h3>
        <div class="fee-breakdown">
          <% if (feeDetails && feeDetails.length > 0) { %> <% feeDetails.forEach(fee => { %>
          <div class="fee-item">
            <div class="fee-details">
              <span class="fee-name"><%= fee.fee_head %></span>
              <span class="fee-period"><%= fee.period %></span>
            </div>
            <div class="fee-amount">₹<%= fee.amount.toLocaleString('en-IN') %></div>
          </div>
          <% }) %> <% } %>
        </div>

        <div class="total-section">
          <div class="subtotal">
            <span>Subtotal:</span>
            <span>₹<span id="subtotal"><%= totalAmount.toLocaleString('en-IN') %></span></span>
          </div>
          <div class="convenience-fee">
            <span>Convenience Fee:</span>
            <span>₹<span id="convenience-fee">0</span></span>
          </div>
          <div class="total-amount">
            <span>Total Amount:</span>
            <span>₹<span id="total-amount"><%= totalAmount.toLocaleString('en-IN') %></span></span>
          </div>
        </div>
      </div>

      <!-- Payment Method Selection -->
      <div class="payment-methods">
        <h3 class="section-title">Select Payment Method</h3>
        <div class="method-options">
          <% if (paymentConfig.enabled_methods.includes('CASH')) { %>
          <div class="method-option" data-method="CASH">
            <div class="method-icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="method-info">
              <div class="method-name">Cash Payment</div>
              <div class="method-desc">Pay at school office</div>
            </div>
          </div>
          <% } %> <% if (paymentConfig.enabled_methods.includes('ONLINE') &&
          paymentConfig.enable_online_payments) { %>
          <div class="method-option" data-method="ONLINE">
            <div class="method-icon">
              <i class="fas fa-globe"></i>
            </div>
            <div class="method-info">
              <div class="method-name">Online Payment</div>
              <div class="method-desc">Credit/Debit Card, Net Banking, UPI</div>
            </div>
          </div>
          <% } %> <% if (paymentConfig.enabled_methods.includes('UPI')) { %>
          <div class="method-option" data-method="UPI">
            <div class="method-icon">
              <i class="fab fa-google-pay"></i>
            </div>
            <div class="method-info">
              <div class="method-name">UPI Payment</div>
              <div class="method-desc">GooglePay, PhonePe, Paytm</div>
            </div>
          </div>
          <% } %> <% if (paymentConfig.enabled_methods.includes('CHEQUE')) { %>
          <div class="method-option" data-method="CHEQUE">
            <div class="method-icon">
              <i class="fas fa-file-invoice"></i>
            </div>
            <div class="method-info">
              <div class="method-name">Cheque Payment</div>
              <div class="method-desc">Bank cheque or DD</div>
            </div>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Gateway Selection (for online payments) -->
      <div class="gateway-selection" style="display: none">
        <h3 class="section-title">Select Payment Gateway</h3>
        <div class="gateway-options">
          <% if (paymentConfig.enabled_gateways &&
          paymentConfig.enabled_gateways.includes('RAZORPAY')) { %>
          <div class="gateway-option" data-gateway="RAZORPAY">
            <img src="/images/gateways/razorpay.png" alt="Razorpay" class="gateway-logo" />
            <span class="gateway-name">Razorpay</span>
          </div>
          <% } %> <% if (paymentConfig.enabled_gateways &&
          paymentConfig.enabled_gateways.includes('PAYTM')) { %>
          <div class="gateway-option" data-gateway="PAYTM">
            <img src="/images/gateways/paytm.png" alt="Paytm" class="gateway-logo" />
            <span class="gateway-name">Paytm</span>
          </div>
          <% } %> <% if (paymentConfig.enabled_gateways &&
          paymentConfig.enabled_gateways.includes('PAYU')) { %>
          <div class="gateway-option" data-gateway="PAYU">
            <img src="/images/gateways/payu.png" alt="PayU" class="gateway-logo" />
            <span class="gateway-name">PayU</span>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Payment Form -->
      <form id="payment-form" class="payment-form" style="display: none">
        <div class="form-section">
          <h3 class="section-title">Payment Details</h3>

          <div class="form-group">
            <label for="payer-name">Payer Name *</label>
            <input
              type="text"
              id="payer-name"
              name="payer_name"
              value="<%= student.parent_name || student.name %>"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="payer-email">Email Address *</label>
              <input
                type="email"
                id="payer-email"
                name="payer_email"
                value="<%= student.email || '' %>"
                required
              />
            </div>
            <div class="form-group">
              <label for="payer-phone">Phone Number *</label>
              <input
                type="tel"
                id="payer-phone"
                name="payer_phone"
                value="<%= student.phone || '' %>"
                required
              />
            </div>
          </div>

          <!-- Cheque Details (conditional) -->
          <div class="cheque-details" style="display: none">
            <div class="form-row">
              <div class="form-group">
                <label for="cheque-number">Cheque Number *</label>
                <input
                  type="text"
                  id="cheque-number"
                  name="cheque_number"
                  pattern="[0-9]{6,8}"
                  title="Enter valid cheque number"
                />
              </div>
              <div class="form-group">
                <label for="cheque-date">Cheque Date *</label>
                <input type="date" id="cheque-date" name="cheque_date" />
              </div>
            </div>
            <div class="form-group">
              <label for="bank-name">Bank Name *</label>
              <input type="text" id="bank-name" name="bank_name" />
            </div>
          </div>

          <div class="form-group">
            <label for="payment-notes">Notes (Optional)</label>
            <textarea
              id="payment-notes"
              name="notes"
              rows="3"
              placeholder="Any additional information..."
            ></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="resetForm()">
            <i class="fas fa-undo"></i> Reset
          </button>
          <button type="submit" class="btn btn-primary" id="pay-button">
            <i class="fas fa-lock"></i>
            <span id="pay-button-text">Pay ₹<%= totalAmount.toLocaleString('en-IN') %></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Payment Status Modal -->
  <div class="modal fade" id="payment-status-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Payment Status</h5>
        </div>
        <div class="modal-body text-center">
          <div class="status-icon">
            <i class="fas fa-spinner fa-spin" id="loading-icon"></i>
            <i class="fas fa-check-circle text-success" id="success-icon" style="display: none"></i>
            <i class="fas fa-times-circle text-danger" id="error-icon" style="display: none"></i>
          </div>
          <div class="status-message" id="status-message">Processing your payment...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .fee-payment-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  .payment-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    text-align: center;
  }

  .payment-title {
    margin: 0 0 15px 0;
    font-size: 28px;
    font-weight: 600;
  }

  .student-info {
    display: flex;
    justify-content: center;
    gap: 20px;
    font-size: 16px;
    opacity: 0.9;
  }

  .card-body {
    padding: 30px;
  }

  .section-title {
    color: #333;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
  }

  .fee-summary {
    margin-bottom: 30px;
  }

  .fee-breakdown {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .fee-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e9ecef;
  }

  .fee-item:last-child {
    border-bottom: none;
  }

  .fee-details {
    display: flex;
    flex-direction: column;
  }

  .fee-name {
    font-weight: 600;
    color: #333;
  }

  .fee-period {
    font-size: 14px;
    color: #666;
  }

  .fee-amount {
    font-weight: 600;
    font-size: 16px;
    color: #28a745;
  }

  .total-section {
    border-top: 2px solid #dee2e6;
    padding-top: 15px;
  }

  .subtotal,
  .convenience-fee,
  .total-amount {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .total-amount {
    font-size: 18px;
    font-weight: 700;
    color: #28a745;
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
    margin-top: 10px;
  }

  .method-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }

  .method-option {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .method-option:hover {
    border-color: #667eea;
    background: #f8f9ff;
  }

  .method-option.selected {
    border-color: #667eea;
    background: #667eea;
    color: white;
  }

  .method-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
  }

  .method-info {
    flex: 1;
  }

  .method-name {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .method-desc {
    font-size: 14px;
    opacity: 0.8;
  }

  .gateway-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }

  .gateway-option {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    min-width: 120px;
  }

  .gateway-option:hover {
    border-color: #667eea;
  }

  .gateway-option.selected {
    border-color: #667eea;
    background: #f8f9ff;
  }

  .gateway-logo {
    height: 30px;
    margin-bottom: 8px;
  }

  .gateway-name {
    display: block;
    font-weight: 600;
    font-size: 14px;
  }

  .payment-form {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 25px;
    margin-top: 20px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.3s ease;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
  }

  .btn {
    padding: 12px 30px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn-secondary:hover {
    background: #545b62;
  }

  .status-icon {
    font-size: 48px;
    margin-bottom: 20px;
  }

  .status-message {
    font-size: 18px;
    margin-bottom: 10px;
  }

  @media (max-width: 768px) {
    .fee-payment-container {
      padding: 10px;
    }

    .card-header {
      padding: 20px;
    }

    .card-body {
      padding: 20px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .method-options {
      grid-template-columns: 1fr;
    }

    .form-actions {
      flex-direction: column;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const methodOptions = document.querySelectorAll('.method-option');
      const gatewayOptions = document.querySelectorAll('.gateway-option');
      const gatewaySelection = document.querySelector('.gateway-selection');
      const paymentForm = document.getElementById('payment-form');
      const chequeDetails = document.querySelector('.cheque-details');
      const payButton = document.getElementById('pay-button');
      const totalAmountElement = document.getElementById('total-amount');
      const convenienceFeeElement = document.getElementById('convenience-fee');

      let selectedMethod = '';
      let selectedGateway = '';
      const baseAmount = <%= totalAmount %>;

      // Payment method selection
      methodOptions.forEach(option => {
          option.addEventListener('click', function() {
              methodOptions.forEach(opt => opt.classList.remove('selected'));
              this.classList.add('selected');
              selectedMethod = this.dataset.method;

              // Show/hide gateway selection for online payments
              if (selectedMethod === 'ONLINE' || selectedMethod === 'UPI') {
                  gatewaySelection.style.display = 'block';
                  updateConvenienceFee();
              } else {
                  gatewaySelection.style.display = 'none';
                  convenienceFeeElement.textContent = '0';
                  updateTotal();
              }

              // Show/hide cheque details
              if (selectedMethod === 'CHEQUE') {
                  chequeDetails.style.display = 'block';
              } else {
                  chequeDetails.style.display = 'none';
              }

              paymentForm.style.display = 'block';
              updatePayButton();
          });
      });

      // Gateway selection
      gatewayOptions.forEach(option => {
          option.addEventListener('click', function() {
              gatewayOptions.forEach(opt => opt.classList.remove('selected'));
              this.classList.add('selected');
              selectedGateway = this.dataset.gateway;
              updateConvenienceFee();
              updatePayButton();
          });
      });

      function updateConvenienceFee() {
          if (selectedMethod === 'ONLINE' || selectedMethod === 'UPI') {
              const feePercentage = <%= paymentConfig.online_fee_percentage || 0 %>;
              const feeFixed = <%= paymentConfig.online_fee_fixed || 0 %>;
              const convenienceFee = Math.round((baseAmount * feePercentage / 100) + feeFixed);
              convenienceFeeElement.textContent = convenienceFee.toLocaleString('en-IN');
              updateTotal();
          }
      }

      function updateTotal() {
          const convenienceFee = parseInt(convenienceFeeElement.textContent.replace(/,/g, '')) || 0;
          const total = baseAmount + convenienceFee;
          totalAmountElement.textContent = total.toLocaleString('en-IN');
          updatePayButton();
      }

      function updatePayButton() {
          const total = parseInt(totalAmountElement.textContent.replace(/,/g, ''));
          document.getElementById('pay-button-text').textContent = `Pay ₹${total.toLocaleString('en-IN')}`;
      }

      // Form submission
      document.getElementById('payment-form').addEventListener('submit', function(e) {
          e.preventDefault();

          if (!selectedMethod) {
              alert('Please select a payment method');
              return;
          }

          if ((selectedMethod === 'ONLINE' || selectedMethod === 'UPI') && !selectedGateway) {
              alert('Please select a payment gateway');
              return;
          }

          processPayment();
      });

      function processPayment() {
          const formData = new FormData(document.getElementById('payment-form'));
          const paymentData = {
              student_id: <%= student.id %>,
              amount: parseInt(totalAmountElement.textContent.replace(/,/g, '')),
              payment_method: selectedMethod,
              gateway_name: selectedGateway,
              payer_name: formData.get('payer_name'),
              payer_email: formData.get('payer_email'),
              payer_phone: formData.get('payer_phone'),
              notes: formData.get('notes'),
              fee_receipt_ids: [<%= feeDetails.map(f => f.id).join(',') %>]
          };

          // Add cheque details if applicable
          if (selectedMethod === 'CHEQUE') {
              paymentData.cheque_number = formData.get('cheque_number');
              paymentData.cheque_date = formData.get('cheque_date');
              paymentData.bank_name = formData.get('bank_name');
          }

          // Show processing modal
          showPaymentStatus('processing', 'Processing your payment...');

          // Submit payment
          fetch('/api/fees/payment/initiate', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(paymentData)
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  if (selectedMethod === 'CASH' || selectedMethod === 'CHEQUE') {
                      showPaymentStatus('success', 'Payment recorded successfully!');
                      setTimeout(() => {
                          window.location.href = '/students/<%= student.id %>/fees';
                      }, 2000);
                  } else {
                      // Redirect to payment gateway
                      window.location.href = data.payment_url;
                  }
              } else {
                  showPaymentStatus('error', data.message || 'Payment failed');
              }
          })
          .catch(error => {
              console.error('Payment error:', error);
              showPaymentStatus('error', 'Payment processing failed');
          });
      }

      function showPaymentStatus(status, message) {
          const modal = new bootstrap.Modal(document.getElementById('payment-status-modal'));
          const loadingIcon = document.getElementById('loading-icon');
          const successIcon = document.getElementById('success-icon');
          const errorIcon = document.getElementById('error-icon');
          const statusMessage = document.getElementById('status-message');

          // Hide all icons
          loadingIcon.style.display = 'none';
          successIcon.style.display = 'none';
          errorIcon.style.display = 'none';

          // Show appropriate icon
          if (status === 'processing') {
              loadingIcon.style.display = 'inline-block';
          } else if (status === 'success') {
              successIcon.style.display = 'inline-block';
          } else {
              errorIcon.style.display = 'inline-block';
          }

          statusMessage.textContent = message;
          modal.show();
      }
  });

  function resetForm() {
      document.getElementById('payment-form').reset();
      document.querySelectorAll('.method-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelectorAll('.gateway-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.gateway-selection').style.display = 'none';
      document.querySelector('.payment-form').style.display = 'none';
      document.querySelector('.cheque-details').style.display = 'none';
  }
</script>

<%- include('../../partials/footer') %>
