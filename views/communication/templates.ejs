<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Communication Templates - School ERP</title>
    <%- include('../partials/head') %>
  </head>
  <body>
    <%- include('../partials/navbar') %>

    <div class="container-fluid">
      <div class="row">
        <%- include('../partials/sidebar') %>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2">Communication Templates</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <button
                type="button"
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#templateModal"
              >
                <i class="fas fa-plus"></i> Create Template
              </button>
            </div>
          </div>

          <!-- Filter and Search -->
          <div class="row mb-4">
            <div class="col-md-4">
              <select class="form-select" id="typeFilter">
                <option value="">All Types</option>
                <option value="email">Email</option>
                <option value="sms">SMS</option>
              </select>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="fee_reminder">Fee Reminder</option>
                <option value="admission_confirmation">Admission Confirmation</option>
                <option value="attendance_alert">Attendance Alert</option>
                <option value="exam_notification">Exam Notification</option>
                <option value="general_announcement">General Announcement</option>
                <option value="payment_confirmation">Payment Confirmation</option>
                <option value="payment_failure">Payment Failure</option>
                <option value="account_activation">Account Activation</option>
                <option value="password_reset">Password Reset</option>
              </select>
            </div>
            <div class="col-md-4">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="Search templates..."
                />
                <button class="btn btn-outline-secondary" type="button" onclick="searchTemplates()">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Templates Table -->
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="templatesTable">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Category</th>
                      <th>Status</th>
                      <th>Default</th>
                      <th>Created</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="templatesTableBody">
                    <!-- Templates will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Template Modal -->
    <div
      class="modal fade"
      id="templateModal"
      tabindex="-1"
      aria-labelledby="templateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="templateModalLabel">Create Template</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="templateForm">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="templateName" class="form-label">Template Name *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="templateName"
                      name="name"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="templateType" class="form-label">Type *</label>
                    <select class="form-select" id="templateType" name="type" required>
                      <option value="">Select Type</option>
                      <option value="email">Email</option>
                      <option value="sms">SMS</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="templateCategory" class="form-label">Category *</label>
                    <select class="form-select" id="templateCategory" name="category" required>
                      <option value="">Select Category</option>
                      <option value="fee_reminder">Fee Reminder</option>
                      <option value="admission_confirmation">Admission Confirmation</option>
                      <option value="attendance_alert">Attendance Alert</option>
                      <option value="exam_notification">Exam Notification</option>
                      <option value="general_announcement">General Announcement</option>
                      <option value="payment_confirmation">Payment Confirmation</option>
                      <option value="payment_failure">Payment Failure</option>
                      <option value="account_activation">Account Activation</option>
                      <option value="password_reset">Password Reset</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <div class="form-check form-switch mt-4">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="templateActive"
                        name="is_active"
                        checked
                      />
                      <label class="form-check-label" for="templateActive"> Active Template </label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mb-3" id="subjectSection">
                <label for="templateSubject" class="form-label">Subject *</label>
                <input
                  type="text"
                  class="form-control"
                  id="templateSubject"
                  name="subject"
                  placeholder="Email subject with variables like {{student_name}}"
                />
              </div>

              <div class="mb-3">
                <label for="templateContent" class="form-label">Content *</label>
                <textarea
                  class="form-control"
                  id="templateContent"
                  name="content"
                  rows="8"
                  required
                  placeholder="Template content with variables like {{student_name}}, {{amount}}, etc."
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="templateDescription" class="form-label">Description</label>
                <textarea
                  class="form-control"
                  id="templateDescription"
                  name="description"
                  rows="2"
                  placeholder="Optional description of this template"
                ></textarea>
              </div>

              <!-- Variable Helper -->
              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0">Available Variables</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <strong>Student Variables:</strong>
                      <ul class="list-unstyled small">
                        <li><code>{{student_name}}</code> - Full student name</li>
                        <li><code>{{first_name}}</code> - Student first name</li>
                        <li><code>{{last_name}}</code> - Student last name</li>
                        <li><code>{{student_id}}</code> - Student ID</li>
                        <li><code>{{class_name}}</code> - Class name</li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <strong>Common Variables:</strong>
                      <ul class="list-unstyled small">
                        <li><code>{{amount}}</code> - Amount/Fee</li>
                        <li><code>{{due_date}}</code> - Due date</li>
                        <li><code>{{payment_date}}</code> - Payment date</li>
                        <li><code>{{transaction_id}}</code> - Transaction ID</li>
                        <li><code>{{academic_year}}</code> - Academic year</li>
                      </ul>
                    </div>
                  </div>
                  <div class="text-muted small">
                    Click on any variable to insert it into the content at cursor position.
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="button" class="btn btn-info" onclick="previewTemplate()">
                Preview
              </button>
              <button type="submit" class="btn btn-primary">Save Template</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Preview Modal -->
    <div
      class="modal fade"
      id="previewModal"
      tabindex="-1"
      aria-labelledby="previewModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="previewModalLabel">Template Preview</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="previewContent">
              <!-- Preview content will be shown here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('../partials/scripts') %>
    <script>
      let currentTemplateId = null;

      $(document).ready(function () {
        loadTemplates();
        initializeFormHandlers();
      });

      function initializeFormHandlers() {
        // Type change handler
        $('#templateType').change(function () {
          if ($(this).val() === 'email') {
            $('#subjectSection').show();
            $('#templateSubject').attr('required', true);
          } else {
            $('#subjectSection').hide();
            $('#templateSubject').attr('required', false);
          }
        });

        // Form submission
        $('#templateForm').submit(function (e) {
          e.preventDefault();
          saveTemplate();
        });

        // Search and filter
        $('#typeFilter, #categoryFilter').change(function () {
          loadTemplates();
        });

        $('#searchInput').keypress(function (e) {
          if (e.which === 13) {
            searchTemplates();
          }
        });

        // Variable insertion
        $('code').click(function () {
          const variable = $(this).text();
          insertAtCursor($('#templateContent')[0], variable);
        });
      }

      function loadTemplates() {
        const filters = {
          type: $('#typeFilter').val(),
          category: $('#categoryFilter').val(),
          search: $('#searchInput').val()
        };

        $.get('/api/communication/templates', filters)
          .done(function (response) {
            if (response.success) {
              displayTemplates(response.data);
            }
          })
          .fail(function (xhr) {
            console.error('Failed to load templates:', xhr.responseJSON);
            showAlert('danger', 'Failed to load templates');
          });
      }

      function displayTemplates(templates) {
        const tbody = $('#templatesTableBody');
        tbody.empty();

        if (templates.length === 0) {
          tbody.append(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">No templates found</td>
                    </tr>
                `);
          return;
        }

        templates.forEach(template => {
          const row = `
                    <tr>
                        <td>${template.name}</td>
                        <td>
                            <span class="badge bg-${template.type === 'email' ? 'primary' : 'info'}">
                                ${template.type.toUpperCase()}
                            </span>
                        </td>
                        <td>${formatCategory(template.category)}</td>
                        <td>
                            <span class="badge bg-${template.is_active ? 'success' : 'secondary'}">
                                ${template.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            ${template.is_default ? '<i class="fas fa-check text-success"></i>' : ''}
                        </td>
                        <td>${formatDate(template.created_at)}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editTemplate(${template.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="previewTemplateById(${template.id})" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${
                                  !template.is_default
                                    ? `
                                    <button class="btn btn-outline-danger" onclick="deleteTemplate(${template.id})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `
                                    : ''
                                }
                            </div>
                        </td>
                    </tr>
                `;
          tbody.append(row);
        });
      }

      function formatCategory(category) {
        return category
          .split('_')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
      }

      function editTemplate(id) {
        $.get(`/api/communication/templates/${id}`)
          .done(function (response) {
            if (response.success) {
              const template = response.data;
              currentTemplateId = id;

              $('#templateModalLabel').text('Edit Template');
              $('#templateName').val(template.name);
              $('#templateType').val(template.type).trigger('change');
              $('#templateCategory').val(template.category);
              $('#templateSubject').val(template.subject || '');
              $('#templateContent').val(template.content);
              $('#templateDescription').val(template.description || '');
              $('#templateActive').prop('checked', template.is_active);

              $('#templateModal').modal('show');
            }
          })
          .fail(function (xhr) {
            console.error('Failed to load template:', xhr.responseJSON);
            showAlert('danger', 'Failed to load template');
          });
      }

      function saveTemplate() {
        const formData = new FormData($('#templateForm')[0]);
        const templateData = Object.fromEntries(formData.entries());

        // Convert checkbox to boolean
        templateData.is_active = $('#templateActive').is(':checked');

        const url = currentTemplateId
          ? `/api/communication/templates/${currentTemplateId}`
          : '/api/communication/templates';
        const method = currentTemplateId ? 'PUT' : 'POST';

        $.ajax({
          url: url,
          method: method,
          data: JSON.stringify(templateData),
          contentType: 'application/json',
          success: function (response) {
            if (response.success) {
              showAlert(
                'success',
                `Template ${currentTemplateId ? 'updated' : 'created'} successfully!`
              );
              $('#templateModal').modal('hide');
              resetForm();
              loadTemplates();
            } else {
              showAlert('danger', response.error.message || 'Failed to save template');
            }
          },
          error: function (xhr) {
            const error = xhr.responseJSON || {};
            showAlert('danger', error.message || 'Failed to save template');
          }
        });
      }

      function deleteTemplate(id) {
        if (confirm('Are you sure you want to delete this template?')) {
          $.ajax({
            url: `/api/communication/templates/${id}`,
            method: 'DELETE',
            success: function (response) {
              if (response.success) {
                showAlert('success', 'Template deleted successfully!');
                loadTemplates();
              } else {
                showAlert('danger', response.error.message || 'Failed to delete template');
              }
            },
            error: function (xhr) {
              const error = xhr.responseJSON || {};
              showAlert('danger', error.message || 'Failed to delete template');
            }
          });
        }
      }

      function previewTemplate() {
        const content = $('#templateContent').val();
        const subject = $('#templateSubject').val();
        const type = $('#templateType').val();

        // Replace sample variables for preview
        const sampleData = {
          student_name: 'John Doe',
          first_name: 'John',
          last_name: 'Doe',
          student_id: 'STD001',
          class_name: 'Class 10-A',
          amount: 'â‚¹5,000',
          due_date: new Date().toLocaleDateString(),
          payment_date: new Date().toLocaleDateString(),
          transaction_id: 'TXN123456789',
          academic_year: '2024-25'
        };

        let previewContent = content;
        let previewSubject = subject;

        Object.keys(sampleData).forEach(key => {
          const regex = new RegExp(`{{${key}}}`, 'g');
          previewContent = previewContent.replace(regex, sampleData[key]);
          if (previewSubject) {
            previewSubject = previewSubject.replace(regex, sampleData[key]);
          }
        });

        let previewHtml = '<div class="preview-template">';

        if (type === 'email' && previewSubject) {
          previewHtml += `<div class="mb-3"><strong>Subject:</strong> ${previewSubject}</div>`;
        }

        if (type === 'email') {
          previewHtml += `<div class="email-content">${previewContent}</div>`;
        } else {
          previewHtml += `<div class="sms-content border p-3 rounded">${previewContent}</div>`;
        }

        previewHtml += '</div>';

        $('#previewContent').html(previewHtml);
        $('#previewModal').modal('show');
      }

      function previewTemplateById(id) {
        $.get(`/api/communication/templates/${id}`)
          .done(function (response) {
            if (response.success) {
              const template = response.data;

              // Temporarily fill form for preview
              $('#templateType').val(template.type);
              $('#templateSubject').val(template.subject || '');
              $('#templateContent').val(template.content);

              previewTemplate();
            }
          })
          .fail(function (xhr) {
            console.error('Failed to load template:', xhr.responseJSON);
            showAlert('danger', 'Failed to load template');
          });
      }

      function searchTemplates() {
        loadTemplates();
      }

      function resetForm() {
        currentTemplateId = null;
        $('#templateForm')[0].reset();
        $('#templateModalLabel').text('Create Template');
        $('#subjectSection').hide();
      }

      // Reset form when modal is hidden
      $('#templateModal').on('hidden.bs.modal', function () {
        resetForm();
      });

      function insertAtCursor(textArea, text) {
        const startPos = textArea.selectionStart;
        const endPos = textArea.selectionEnd;
        const beforeText = textArea.value.substring(0, startPos);
        const afterText = textArea.value.substring(endPos, textArea.value.length);

        textArea.value = beforeText + text + afterText;
        textArea.selectionStart = textArea.selectionEnd = startPos + text.length;
        textArea.focus();
      }

      function showAlert(type, message) {
        const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

        $('.alert').remove();
        $('main').prepend(alertHtml);

        setTimeout(function () {
          $('.alert').fadeOut();
        }, 5000);
      }
    </script>

    <style>
      .preview-template {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
      }

      .email-content {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
        border-left: 4px solid #0d6efd;
      }

      .sms-content {
        background: #e3f2fd;
        font-family: monospace;
        font-size: 0.9rem;
      }

      code {
        cursor: pointer;
        background-color: #e9ecef;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
      }

      code:hover {
        background-color: #adb5bd;
      }
    </style>
  </body>
</html>
